<!doctype html>

<header>
    <meta charset="utf-8">
    <title>Hello from Flask</title>
    <script src="/static/js/d3.v4.min.js"></script>
    <!-- <script src="/static/js/simplify.js"></script> -->
    <script src="https://unpkg.com/geojson-vt@3.2.0/geojson-vt.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
    <script src="https://bost.ocks.org/mike/simplify/simplify.js"></script>
    
    <style>
        body { margin:0;position:fixed;top:0;right:0;bottom:0;left:0; }
        svg { width:100%; height: 100% }
    </style>
</header>
<body>
  <div class="app"></div>
  <script type="text/javascript">
      var width = 600;
      var height = 600;
      // var url = "/topoaachen";
      // var url = "/topodeu";
      var url = "/static/deu.topojson";
      // var url = "http://enjalot.github.io/wwsd/data/world/world-110m.geojson";

      d3.json(url, function(err, tj) {
        if (err) throw err;

        // topo = topojson.topology(geojson.features);
        var tj = topojson.presimplify(tj);
        tjj = tj;
        geojson = topojson.feature( tj, tj.objects.primary );

        var svg = d3.select(".app")
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .on("click", stopped, true);

            g = svg.append("g")

        // Determine a good projection to match the data
        
        var mapprojection = d3.geoMercator()
            .fitExtent( [[0,0],[width,height]], geojson)
            .clipExtent([[0, 0], [width, height]])
        var minZOriginal = 1/mapprojection.scale(), minZ = minZOriginal;

        // var clipWindow = d3.geoIdentity().clipExtent([[0, 0], [width, height]])
        var simplification = d3.geoTransform({point: function(x, y, z) { if (z>=minZ) return this.stream.point(x, y); }});
        
        var projection = {
              stream: function(s) {
                return simplification.stream(mapprojection.stream(s)); // WOOOOOW, javascript sucks...order is reversed
                // return mapprojection.stream(s);
              }
            };

        // Make path mapper and create region instance
        path = d3.geoPath().projection(projection);

        var region = g.selectAll("path")
                      .data(geojson.features).enter().append("path")
                      .attr("d", path( geojson ));

        // Add zooming and dragging
        var zoom = d3.zoom()
                     .on("zoom", zoomed);

        function zoomed(d) {
          var t = d3.event.transform;
          minZ = Math.min(minZOriginal, minZOriginal / (t.k * t.k));
          g.attr("transform", d3.event.transform);
          g.selectAll("path").attr("d", path( geojson ));
          // transform.translate([t.x, t.y]).scale(t.k);
          // context.clearRect(0, 0, width, height);
          // context.beginPath();
          // path(land);
          // context.fill();
          // context.beginPath();
          // path(borders);
          // context.stroke();
        }

        svg.call(zoom);
       
      })

      // If the drag behavior prevents the default click,
      // also stop propagation so we donâ€™t click-to-zoom.
      function stopped() {
        if (d3.event.defaultPrevented) d3.event.stopPropagation();
      }


  </script>
</body>